# Refactoring Plan: Deep MagicString Integration for Civet Sourcemaps in Svelte

## 1. Executive Summary & Goals

This plan details an alternative refactoring strategy ("Approach B") for Civet sourcemap integration within `svelte2tsx`. Instead of refining the existing `civetMapChainer.ts`, this approach aims to leverage `MagicString`'s capabilities more deeply, specifically using `addSourcemapLocation` and high-resolution map generation, as suggested by insights in `[72log]`. The goal is to produce a single, accurate sourcemap directly from `svelte2tsx` that correctly maps final TSX output back to the original Civet code in `.svelte` files.

**Key Goals:**

1.  **Direct & Unified Sourcemap Generation:** Generate a single sourcemap from `svelte2tsx` that accurately incorporates Civet's original source locations, aiming to make `civetMapChainer.ts` obsolete or significantly simpler.
2.  **Preserve Civet Precision:** Ensure the detailed line and column information from the Civet-to-TypeScript compilation (`normalizedMap`) is preserved in the final TSX-to-Original-Svelte-Civet map.
3.  **Robust Integration:** Create a more robust and potentially simpler sourcemapping pipeline by integrating Civet map information at an earlier stage within `svelte2tsx`.

## 2. Current Situation Analysis (Context for Approach B)

The existing pipeline uses `civetPreprocessor.ts` to convert Civet to TS (producing `normalizedMap`: Svelte Civet -> Civet's TS) and then `svelte2tsx/index.ts` to convert Svelte-with-TS to TSX (producing `baseMap`: Svelte-with-TS -> TSX). A separate `civetMapChainer.ts` then attempts to merge these. This chaining process is complex and has led to bugs like the `foo1` hover issue, where coarse mappings in `baseMap` override finer details from `normalizedMap`.

"Approach B" is inspired by `[72log]` which suggests that `MagicString.addSourcemapLocation` used in conjunction with `generateMap({ hires: true })` can achieve a direct merge of Civet and template mappings into one unified map, potentially avoiding the complexities and pitfalls of the current multi-stage chaining.

## 3. Proposed Solution / Refactoring Strategy (Approach B)

This strategy focuses on refactoring `packages/svelte2tsx/src/svelte2tsx/index.ts` to directly handle the integration of Civet sourcemaps.

### 3.1. High-Level Design / Architectural Overview

1.  **Preprocessing & Map Preparation (`civetPreprocessor.ts` or similar logic within `svelte2tsx/index.ts`):**
    *   Civet code within `<script lang="civet">` is extracted.
    *   This Civet code is compiled into a TypeScript snippet (`compiledCivetTs`).
    *   A sourcemap (`normalizedMap`) is generated mapping this `compiledCivetTs` back to the original Civet code's precise locations (line and column) within the `.svelte` file.
    *   Crucially, `normalizedMap.sources[0]` must be patched to the Svelte file's path, and `normalizedMap.sourcesContent[0]` should be the full original Svelte file content. (The existing `normalizeCivetMap` in `civetMapToV3.ts` handles this).

2.  **Core `svelte2tsx/index.ts` Refactor:**
    *   The main `MagicString` instance (`str`) in `svelte2tsx/index.ts` will be initialized with `svelteWithTs` (Svelte content where Civet script blocks have been replaced by `compiledCivetTs`).
    *   **Injection with Sourcemap Hinting (as per `[72log]` interpretation):**
        *   When `compiledCivetTs` is used to overwrite the original Civet script's location in `str` (e.g., via `str.overwrite(originalCivetStart, originalCivetEnd, compiledCivetTs)`), `MagicString.addSourcemapLocation()` will be used.
        *   The `[72log]` states: "Surround the injection with `MagicString.addSourcemapLocation(startOffset)` and `addSourcemapLocation(endOffset)` to preserve original Civet positions." These offsets likely refer to the boundaries of the `compiledCivetTs` *within the `str` instance's current content* (i.e., within `svelteWithTs`).
        *   The hypothesis from `[72log]` is that these `addSourcemapLocation` calls, combined with `str.generateMap({ hires: true })`, will enable `MagicString` to properly merge the `normalizedMap` information for the `compiledCivetTs` content into the final sourcemap.

3.  **Final Sourcemap Generation:**
    *   A single call to `str.generateMap({ hires: true, includeContent: true })` is expected to produce the final, unified sourcemap mapping TSX directly back to the original Svelte/Civet code.

### 3.2. Key Components / Modules to Modify

1.  **`packages/svelte2tsx/src/svelte2tsx/index.ts`:**
    *   Will orchestrate the Civet compilation (if not delegating entirely to `preprocessCivet` for the map/TS generation).
    *   Will manage the `normalizedMap` instance.
    *   Will be responsible for the `str.overwrite()` call for Civet-derived TS.
    *   Will implement the `addSourcemapLocation()` calls around the injected TS.
    *   Will call `str.generateMap({ hires: true })`.
2.  **`packages/svelte2tsx/src/svelte2tsx/utils/civetPreprocessor.ts` & `civetMapToV3.ts`:**
    *   These will continue to be responsible for generating `compiledCivetTs` and the correctly structured `normalizedMap` (mapping `compiledCivetTs` back to original Svelte/Civet locations, with patched `sources` and `sourcesContent`). No major changes anticipated here, but their output quality is critical.
3.  **`packages/svelte2tsx/src/svelte2tsx/utils/civetMapChainer.ts`:**
    *   This module may become obsolete if "Approach B" is fully successful.

### 3.3. Detailed Action Plan / Phases

**Phase 1: Setup & `normalizedMap` Preparation**
   - Objective(s): Ensure `normalizedMap` is correctly generated and available within `svelte2tsx/index.ts`.
   - **Priority:** High
   - Task 1.1: Civet Compilation and `normalizedMap` Generation.
      - **Rationale/Goal:** Consistently produce `compiledCivetTs` and `normalizedMap` (Civet-TS -> Svelte/Civet).
      - **Action:**
         - Ensure `preprocessCivet` (or equivalent logic if moved into `svelte2tsx/index.ts`) correctly calls `compileCivet` and then `normalizeCivetMap`.
         - Verify `normalizedMap.sources[0]` is the Svelte file path and `sourcesContent[0]` is the full original Svelte content.
         - The `normalizedMap` should precisely map tokens in `compiledCivetTs` to their Svelte/Civet origins.
      - **Estimated Effort:** S (Mostly verification of existing logic)
      - **Deliverable/Criteria for Completion:** `civetModuleInfo.map` and `civetInstanceInfo.map` are correctly populated `normalizedMap` instances.

**Phase 2: `MagicString` Integration in `svelte2tsx/index.ts`**
   - Objective(s): Implement the core `addSourcemapLocation` strategy.
   - **Priority:** High
   - Task 2.1: Modify Script Processing in `svelte2tsx/index.ts`.
      - **Rationale/Goal:** Integrate the `addSourcemapLocation` calls when overwriting original Civet script locations with `compiledCivetTs`.
      - **Action:**
         - In `svelte2tsx/index.ts`, after `preprocessCivet` provides `compiledCivetTs` and `civetModuleInfo`/`civetInstanceInfo`:
         - The `str` (MagicString instance) is initialized with `svelteWithTs`.
         - Identify the `start` and `end` offsets in `svelteWithTs` that correspond to where `compiledCivetTs` has replaced original Civet code. These are available from `civetModuleInfo.tsStartInSvelteWithTs` and `civetModuleInfo.tsEndInSvelteWithTs` (and similarly for instance scripts).
         - **Crucial Step (Interpreting `[72log]`):**
           The "injection via `addSourcemapLocation`" implies that `MagicString` needs to be told about the underlying source map (`normalizedMap`) for the `compiledCivetTs` content that is being placed into `str`.
           The most direct interpretation of `[72log]` "Surround the injection with `MagicString.addSourcemapLocation(startOffset)` and `addSourcemapLocation(endOffset)`" might be to mark the characters *in the output string `str`* that correspond to the start and end of the `compiledCivetTs` block.
           Example for an instance script:
           ```typescript
           // str is MagicString on svelteWithTs
           // scriptTag refers to the <script> tag in svelteWithTs that now contains compiledCivetTs
           // compiledCivetTs is the actual TS code string

           // Option A (literal interpretation of "surround the injection"):
           // This marks locations in the *final output `str` where compiledCivetTs resides.
           // How MagicString uses these markers with `normalizedMap` is the core investigation.
           str.addSourcemapLocation(scriptTag.content.start); // Mark start of TS in final output
           // The content is already `compiledCivetTs` due to preprocessCivet
           str.addSourcemapLocation(scriptTag.content.end -1 ); // Mark end of TS in final output (before closing script tag)
           
           // It's more likely that the "injection" refers to how MagicString *internally*
           // handles the `compiledCivetTs` content when it was placed by `preprocessCivet`'s
           // own MagicString instance. The `str` in svelte2tsx/index.ts *receives* svelteWithTs.
           // So, the `addSourcemapLocation` calls in `svelte2tsx/index.ts` might be for str.original
           // which is svelteWithTs.
           
           // Let's assume for the plan that `civetPreprocessor.ts` already did the `overwrite`
           // and potentially used its own `addSourcemapLocation` calls.
           // `svelte2tsx/index.ts` then receives `svelteWithTs` and the `civetBlockInfo`.
           // The `svelte2tsx/index.ts` main `str` is initialized with `svelteWithTs`.
           // Its `generateMap` will map TSX -> svelteWithTs.
           // The information from `civetBlockInfo.map` (`normalizedMap`) needs to be combined.

           // The `[72log]` might simplify: If `civetPreprocessor.ts` itself produces a `MagicString`
           // instance as output, along with `normalizedMap`, then `svelte2tsx` could *bundle* these.
           // This seems more advanced than simple `addSourcemapLocation` calls.

           // FOCUS FOR THIS TASK based on `[72log]`'s "svelte2tsx/index.ts to compile Civet... inject TS via addSourcemapLocation":
           // This implies `svelte2tsx/index.ts` does the Civet compilation and `overwrite`.
           // If `preprocessCivet` already replaces Civet with TS and passes `svelteWithTs` to `svelte2tsx`,
           // then `svelte2tsx/index.ts`'s `str` is initialized with `svelteWithTs`.
           // The `addSourcemapLocation` calls in `svelte2tsx/index.ts` would be on `str`.
           // These calls likely mark the bounds of the `compiledCivetTs` *within `str`'s content*.
           // Example: If `civetInstanceInfo` is present:
           //  `str.addSourcemapLocation(civetInstanceInfo.tsStartInSvelteWithTs);`
           //  `str.addSourcemapLocation(civetInstanceInfo.tsEndInSvelteWithTs - 1);`
           // These mark points in `svelteWithTs`. It's still unclear how `str.generateMap()` uses these
           // with the external `normalizedMap` to achieve a merge.
           ```
           The critical piece missing is how `MagicString` is told "for the content between these markers (which is `compiledCivetTs`), its original source is *not* simply `svelteWithTs` at these markers, but rather the Svelte/Civet locations found by looking up `compiledCivetTs` positions in `normalizedMap`."
      - **Estimated Effort:** L (High uncertainty, depends on `MagicString` behavior)
      - **Deliverable/Criteria for Completion:** `svelte2tsx/index.ts` modified to include `addSourcemapLocation` calls as per the interpretation of `[72log]`. `civetModuleInfo` and `civetInstanceInfo` (containing `normalizedMap`) are used.

**Phase 3: Sourcemap Generation & Merge Validation**
   - Objective(s): Test the hypothesis that `generateMap({ hires: true })` performs the merge.
   - **Priority:** High
   - Task 3.1: Call `str.generateMap({ hires: true, includeContent: true })`.
      - **Rationale/Goal:** Attempt to generate the single, merged sourcemap.
      - **Estimated Effort:** S
      - **Deliverable/Criteria for Completion:** `finalMap` produced from `str.generateMap()`.
   - Task 3.2: Validate the `finalMap`.
      - **Rationale/Goal:** Check if `finalMap` correctly maps TSX (from Civet) to original Svelte/Civet locations. This is where the `[72log]` hypothesis is tested.
      - **Action:** Use `TraceMap` and `originalPositionFor` with the `foo1` test case (`twoFooUserRequest.svelte`).
      - **Estimated Effort:** M
      - **Deliverable/Criteria for Completion:** Test for `foo1` yields Svelte Line 2, Column 9. If not, proceed to Task 3.3.
   - Task 3.3: (Contingency) Investigate Merge Failure / Implement Manual Merge.
      - **Rationale/Goal:** If `generateMap` does not automatically merge using `normalizedMap`, understand why and implement a fallback.
      - **Action:**
         - Analyze why `MagicString` with `addSourcemapLocation` and `hires: true` didn't use `normalizedMap`.
         - **Fallback Strategy:** If the "magic merge" fails, the `finalMap` from Task 3.1 is effectively `baseMap` (TSX -> `svelteWithTs`). A refined version of `chainMaps` logic will be needed. This refined logic would iterate `finalMap`'s segments. If a segment's original target (in `svelteWithTs`) falls within a `compiledCivetTs` block (identified by `civetModuleInfo.tsStartInSvelteWithTs` etc.), then:
            1. Calculate the position within `compiledCivetTs`.
            2. Use `normalizedMap.originalPositionFor` to get the true Svelte/Civet location.
            3. Create a *new* final sourcemap by adjusting these segments. This is essentially reimplementing a more direct `chainMaps`.
      - **Estimated Effort:** L (If fallback is needed)
      - **Deliverable/Criteria for Completion:** A working sourcemap, either via direct merge or the fallback manual merge.

**Phase 4: Testing & Refinement**
   - Objective(s): Ensure broad correctness and fix any remaining issues.
   - **Priority:** High
   - Task 4.1: Comprehensive Testing.
      - **Rationale/Goal:** Test with a wider range of Civet constructs and Svelte component structures.
      - **Estimated Effort:** M
      - **Deliverable/Criteria for Completion:** All relevant existing tests pass, new tests for edge cases pass.
   - Task 4.2: Deprecate/Remove `civetMapChainer.ts`.
      - **Rationale/Goal:** If Approach B is successful, the old chainer is no longer needed.
      - **Estimated Effort:** S
      - **Deliverable/Criteria for Completion:** `civetMapChainer.ts` removed or marked as deprecated.

**Phase 5: Documentation & Cleanup**
   - Objective(s): Document the new architecture and clean up code.
   - **Priority:** Medium
   - Task 5.1: Update Code Comments and Documentation.
      - **Rationale/Goal:** Explain the new sourcemap generation logic within `svelte2tsx/index.ts`.
      - **Estimated Effort:** S
      - **Deliverable/Criteria for Completion:** Clear documentation.
   - Task 5.2: Review and Remove Debug Logging.
      - **Rationale/Goal:** Ensure production code is clean.
      - **Estimated Effort:** XS
      - **Deliverable/Criteria for Completion:** Debug logs removed/guarded.

### 3.4. Data Model Changes
   - `CivetBlockInfo` (containing `normalizedMap` and positional data) becomes a more central piece of data passed around within `svelte2tsx/index.ts`.

### 3.5. API Design / Interface Changes
   - Internal function signatures within `svelte2tsx/index.ts` and its helper modules for script processing might change to accept `normalizedMap` or `CivetBlockInfo`.
   - The external API of `svelte2tsx()` (input/output) should remain unchanged.

## 4. Key Considerations & Risk Mitigation

### 4.1. Technical Risks & Challenges
   - **Uncertainty of `MagicString` "Magic Merge":** The primary risk is that the `[72log]`'s assertion about `addSourcemapLocation` + `hires: true` leading to an automatic merge with an external map (`normalizedMap`) might be based on a misunderstanding or a very specific, undocumented `MagicString` behavior/version.
     - **Mitigation:** Task 3.3 explicitly defines a contingency plan to implement a more direct, albeit manual, merge if the automatic one fails. This fallback is similar to a refined `chainMaps`.
   - **Complexity of Token-Level Correlation:** If the "magic merge" fails and the fallback requires correlating TSX tokens to `compiledCivetTs` tokens and then to Svelte/Civet tokens, this can be complex.
     - **Mitigation:** Leverage existing AST parsing and traversal logic carefully. Start with named identifiers.
   - **Performance:** If detailed, token-by-token processing and map lookups are needed in the fallback (Task 3.3), performance must be monitored.
     - **Mitigation:** Optimize map lookups. `TraceMap` is generally efficient.

### 4.2. Dependencies
   - **Internal:** Correct functioning of `civetPreprocessor.ts` and `normalizeCivetMap.ts` to produce an accurate `normalizedMap` is paramount.
   - **External:** Relies on the behavior of `MagicString` and `@jridgewell/trace-mapping`.

### 4.3. Non-Functional Requirements (NFRs) Addressed
   - **Maintainability:** If the "magic merge" works, maintainability could improve by simplifying the overall pipeline. If the fallback is needed, complexity might remain similar to a refined `chainMaps`.
   - **Reliability & Accuracy:** This approach directly targets improving sourcemap accuracy.
   - **Performance:** To be monitored, especially if the fallback in Task 3.3 is required.

## 5. Success Metrics / Validation Criteria

-   **Primary Metric:** The `foo1` hover bug (from `6 - userReportedHover#current.test.ts`) is fixed: TSX `foo1` maps to Svelte Line 2, Column 9.
-   **Secondary Metrics:**
    -   A single sourcemap is generated by `svelte2tsx`.
    -   The new approach passes a comprehensive suite of tests covering various Civet constructs and Svelte component structures.
    -   Overall stability and performance of `svelte2tsx` are maintained or improved.

## 6. Assumptions Made

-   The core hypothesis of `[72log]` regarding `MagicString.addSourcemapLocation` and `generateMap({ hires: true })` being able to merge/utilize an external `normalizedMap` for overwritten content is a key assumption to be validated in Phase 3.
-   `normalizedMap` (Civet-TS -> Svelte/Civet) provided by `preprocessCivet` (using `normalizeCivetMap`) is accurate and its `sources`/`sourcesContent` correctly reference the original Svelte file.
-   `MagicString` version in use supports `hires: true` and any other relevant features.

## 7. Open Questions / Areas for Further Investigation

-   **The Exact Mechanism of `MagicString` Merge:** How precisely does `addSourcemapLocation` (when used to "surround an injection") interact with `generateMap({ hires: true })` to incorporate an external sourcemap like `normalizedMap` for the injected content? This is the main point for investigation in Task 3.2 / 3.3. Does it require a specific `MagicString` setup, version, or undocumented feature?
-   **Scope of `addSourcemapLocation`:** Does it mark single characters, or can it apply to ranges in conjunction with `overwrite` to associate a sub-map?
-   **Interaction with Other `MagicString` Operations:** How do other transformations made by `svelte2tsx` (e.g., for template, other script logic) affect the sourcemap when this new Civet integration method is used?

This plan focuses on validating and implementing the "Approach B" strategy as interpreted from `[72log]`. The contingency in Task 3.3 is crucial if the direct merge behavior of `MagicString` is not as straightforward as implied.