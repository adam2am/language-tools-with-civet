
> svelte2tsx@0.7.35 test-current /home/user/Documents/repos/ltools-backup/packages/svelte2tsx
> mocha test/test.ts --grep "#current"



  2.1 - Preprocessor loop mapping differences #current

--- Scenario: Loop without trailing comment (loopBadExp.svelte) ---
[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopBadExp.svelte] Initializing for /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopBadExp.svelte
[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopBadExp.svelte] Found <script lang="civet"> (instance) at content start 21, end 126
[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopBadExp.svelte] Original snippet from Svelte (21-126):

	fruits := ["apple", "mango"]
	for fruit, index of fruits
	  console.log `Fruit ${index + 1}: ${fruit}`

[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopBadExp.svelte] Dedent Info: removedIndentString="	" (length: 1)
[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopBadExp.svelte] Dedented snippet (removed 1 chars of indent):
fruits := ["apple", "mango"]
for fruit, index of fruits
  console.log `Fruit ${index + 1}: ${fruit}`

[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopBadExp.svelte] Civet compiled to TS:
const fruits = ["apple", "mango"]
let i = 0;for (const fruit of fruits) {const index = i++;
  console.log(`Fruit ${index + 1}: ${fruit}`)
}

[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopBadExp.svelte] Raw Civet-to-TS map (first 3 lines of mappings): [[[0,0,0,6],[6,0,0,0],[6,0,0,6],[1,0,0,7],[1,0,0,9],[1,0,0,10],[1,0,0,11],[7,0,0,18],[1,0,0,19],[1,0,0,20],[7,0,0,27],[1,0,0,28]],[[0,0,1,0],[0,0,1,0],[4],[1],[4],[1,0,1,0],[3,0,1,3],[1,0,1,4],[1,0,1,4],[6,0,1,4],[5,0,1,16],[1,0,1,17],[2,0,1,19],[1,0,1,20],[6,0,1,26],[1,0,1,26],[1,0,1,26],[1,0,1,10],[0,0,1,11],[6,0,1,11],[5],[3],[1],[2],[1,0,1,26]],[[0,0,2,0],[0,0,2,0],[2,0,2,2],[7,0,2,9],[1,0,2,10],[3,0,2,13],[1,0,2,13],[0,0,2,14],[1,0,2,15],[6,0,2,21],[2,0,2,23],[5,0,2,28],[1,0,2,29],[1,0,2,30],[1,0,2,31],[1,0,2,32],[1,0,2,33],[2,0,2,35],[2,0,2,37],[5,0,2,42],[1,0,2,43],[1,0,2,44],[1]]]
[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopBadExp.svelte] Original content start in Svelte: line 2 (0-based offset: 1)
[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopBadExp.svelte] Normalizing Civet map. originalContentStartLine: 2, removedIndentLength: 1, filename: /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopBadExp.svelte
[MAP_TO_V3 /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopBadExp.svelte] Normalizing Civet map. Snippet line offset in Svelte (0-based): 1
[MAP_TO_V3 /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopBadExp.svelte] Final Normalized Civet-Svelte map (first 3 lines of mappings): AACO,MAAN,MAAM,CAAC,CAAE,CAAC,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC;AAC5B,AAAA,UAAA,GAAG,CAAC,CAAA,MAAA,KAAY,CAAC,EAAE,CAAC,MAAM,CAAA,CAAA,CAAhB,AAAC,MAAA,YAAe;AAC1B,AAAA,EAAE,OAAO,CAAC,GAAG,CAAA,AAAC,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,EAAE,KAAK,CAAC,CAAC
[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopBadExp.svelte] Normalized Civet-Svelte map (first 3 lines of mappings): AACO,MAAN,MAAM,CAAC,CAAE,CAAC,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC;AAC5B,AAAA,UAAA,GAAG,CAAC,CAAA,MAAA,KAAY,CAAC,EAAE,CAAC,MAAM,CAAA,CAAA,CAAhB,AAAC,MAAA,YAAe;AAC1B,AAAA,EAAE,OAAO,CAAC,GAAG,CAAA,AAAC,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,EAAE,KAAK,CAAC,CAAC
[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopBadExp.svelte] Reindented compiled TS code for insertion (indent: "	"):

	const fruits = ["apple", "mango"]
	let i = 0;for (const fruit of fruits) {const index = i++;
	  console.log(`Fruit ${index + 1}: ${fruit}`)
	}

Original Svelte Content:
 <script lang="civet">
	fruits := ["apple", "mango"]
	for fruit, index of fruits
	  console.log `Fruit ${index + 1}: ${fruit}`
</script>
<div>{fruits}</div> 
Compiled TS Code (from preprocessor):
 const fruits = ["apple", "mango"]
	let i = 0;for (const fruit of fruits) {const index = i++;
	  console.log(`Fruit ${index + 1}: ${fruit}`)
	}

Info from CivetBlockInfo:
  originalContentStartLine_1based: 2
  originalCivetLineCount: 5
  compiledTsLineCount: 6
Raw Civet-to-TS map lines (first 3): [
  [
    [ 0, 0, 0, 6 ],
    [ 6, 0, 0, 0 ],
    [ 6, 0, 0, 6 ],
    [ 1, 0, 0, 7 ],
    [ 1, 0, 0, 9 ],
    [ 1, 0, 0, 10 ],
    [ 1, 0, 0, 11 ],
    [ 7, 0, 0, 18 ],
    [ 1, 0, 0, 19 ],
    [ 1, 0, 0, 20 ],
    [ 7, 0, 0, 27 ],
    [ 1, 0, 0, 28 ]
  ],
  [
    [ 0, 0, 1, 0 ],  [ 0, 0, 1, 0 ],
    [ 4 ],           [ 1 ],
    [ 4 ],           [ 1, 0, 1, 0 ],
    [ 3, 0, 1, 3 ],  [ 1, 0, 1, 4 ],
    [ 1, 0, 1, 4 ],  [ 6, 0, 1, 4 ],
    [ 5, 0, 1, 16 ], [ 1, 0, 1, 17 ],
    [ 2, 0, 1, 19 ], [ 1, 0, 1, 20 ],
    [ 6, 0, 1, 26 ], [ 1, 0, 1, 26 ],
    [ 1, 0, 1, 26 ], [ 1, 0, 1, 10 ],
    [ 0, 0, 1, 11 ], [ 6, 0, 1, 11 ],
    [ 5 ],           [ 3 ],
    [ 1 ],           [ 2 ],
    [ 1, 0, 1, 26 ]
  ],
  [
    [ 0, 0, 2, 0 ],  [ 0, 0, 2, 0 ],
    [ 2, 0, 2, 2 ],  [ 7, 0, 2, 9 ],
    [ 1, 0, 2, 10 ], [ 3, 0, 2, 13 ],
    [ 1, 0, 2, 13 ], [ 0, 0, 2, 14 ],
    [ 1, 0, 2, 15 ], [ 6, 0, 2, 21 ],
    [ 2, 0, 2, 23 ], [ 5, 0, 2, 28 ],
    [ 1, 0, 2, 29 ], [ 1, 0, 2, 30 ],
    [ 1, 0, 2, 31 ], [ 1, 0, 2, 32 ],
    [ 1, 0, 2, 33 ], [ 2, 0, 2, 35 ],
    [ 2, 0, 2, 37 ], [ 5, 0, 2, 42 ],
    [ 1, 0, 2, 43 ], [ 1, 0, 2, 44 ],
    [ 1 ]
  ]
]
Normalized V3 map from Preprocessor (first 3 mapping lines):
AACO,MAAN,MAAM,CAAC,CAAE,CAAC,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC;AAC5B,AAAA,UAAA,GAAG,CAAC,CAAA,MAAA,KAAY,CAAC,EAAE,CAAC,MAAM,CAAA,CAAA,CAAhB,AAAC,MAAA,YAAe;AAC1B,AAAA,EAAE,OAAO,CAAC,GAAG,CAAA,AAAC,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,EAAE,KAAK,CAAC,CAAC
Decoded V3 mapping segments:
  TS Line 1: [0,0,1,7] [6,0,1,1] [12,0,1,7] [13,0,1,8] [14,0,1,10] [15,0,1,11] [16,0,1,12] [23,0,1,19] [24,0,1,20] [25,0,1,21] [32,0,1,28] [33,0,1,29]
  TS Line 2: [0,0,2,1] [0,0,2,1] [10,0,2,1] [13,0,2,4] [14,0,2,5] [15,0,2,5] [21,0,2,5] [26,0,2,17] [27,0,2,18] [29,0,2,20] [30,0,2,21] [36,0,2,27] [37,0,2,27] [38,0,2,27] [39,0,2,11] [39,0,2,12] [45,0,2,12] [57,0,2,27]
  TS Line 3: [0,0,3,1] [0,0,3,1] [2,0,3,3] [9,0,3,10] [10,0,3,11] [13,0,3,14] [14,0,3,14] [14,0,3,15] [15,0,3,16] [21,0,3,22] [23,0,3,24] [28,0,3,29] [29,0,3,30] [30,0,3,31] [31,0,3,32] [32,0,3,33] [33,0,3,34] [35,0,3,36] [37,0,3,38] [42,0,3,43] [43,0,3,44] [44,0,3,45]
  TS Line 4: [0,0,3,45] [1,0,3,45]
  TS Line 5: [0,0,4,1]
  Asserted token 'fruits_def' ('fruits'): TS(1:6) -> Original(2:1) - OK
    1) should correctly map tokens for Loop without trailing comment

--- Scenario: Loop with trailing comment (loopGoodExp.svelte) ---
[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopGoodExp.svelte] Initializing for /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopGoodExp.svelte
[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopGoodExp.svelte] Found <script lang="civet"> (instance) at content start 21, end 137
[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopGoodExp.svelte] Original snippet from Svelte (21-137):

	fruits := ["apple", "mango"]
	for fruit, index of fruits
	  console.log `Fruit ${index + 1}: ${fruit}`
// Comment

[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopGoodExp.svelte] Dedent Info: removedIndentString="" (length: 0)
[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopGoodExp.svelte] Dedented snippet (removed 0 chars of indent):
	fruits := ["apple", "mango"]
	for fruit, index of fruits
	  console.log `Fruit ${index + 1}: ${fruit}`
// Comment

[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopGoodExp.svelte] Civet compiled to TS:
	const fruits = ["apple", "mango"]
	let i = 0;for (const fruit of fruits) {const index = i++;
	  console.log(`Fruit ${index + 1}: ${fruit}`)
	}
// Comment

[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopGoodExp.svelte] Raw Civet-to-TS map (first 3 lines of mappings): [[[0,0,0,0],[1,0,0,7],[6,0,0,1],[6,0,0,7],[1,0,0,8],[1,0,0,10],[1,0,0,11],[1,0,0,12],[7,0,0,19],[1,0,0,20],[1,0,0,21],[7,0,0,28],[1,0,0,29]],[[0,0,1,0],[0,0,1,0],[1],[4],[1],[4],[1,0,1,1],[3,0,1,4],[1,0,1,5],[1,0,1,5],[6,0,1,5],[5,0,1,17],[1,0,1,18],[2,0,1,20],[1,0,1,21],[6,0,1,27],[1,0,1,27],[1,0,1,27],[1,0,1,11],[0,0,1,12],[6,0,1,12],[5],[3],[1],[2],[1,0,1,27]],[[0,0,2,0],[0,0,2,0],[3,0,2,3],[7,0,2,10],[1,0,2,11],[3,0,2,14],[1,0,2,14],[0,0,2,15],[1,0,2,16],[6,0,2,22],[2,0,2,24],[5,0,2,29],[1,0,2,30],[1,0,2,31],[1,0,2,32],[1,0,2,33],[1,0,2,34],[2,0,2,36],[2,0,2,38],[5,0,2,43],[1,0,2,44],[1,0,2,45],[1]]]
[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopGoodExp.svelte] Original content start in Svelte: line 2 (0-based offset: 1)
[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopGoodExp.svelte] Normalizing Civet map. originalContentStartLine: 2, removedIndentLength: 0, filename: /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopGoodExp.svelte
[MAP_TO_V3 /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopGoodExp.svelte] Normalizing Civet map. Snippet line offset in Svelte (0-based): 1
[MAP_TO_V3 /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopGoodExp.svelte] Final Normalized Civet-Svelte map (first 3 lines of mappings): AACA,CAAO,MAAN,MAAM,CAAC,CAAE,CAAC,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC;AAC7B,AAAA,WAAC,GAAG,CAAC,CAAA,MAAA,KAAY,CAAC,EAAE,CAAC,MAAM,CAAA,CAAA,CAAhB,AAAC,MAAA,YAAe;AAC3B,AAAA,GAAG,OAAO,CAAC,GAAG,CAAA,AAAC,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,EAAE,KAAK,CAAC,CAAC
[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopGoodExp.svelte] Normalized Civet-Svelte map (first 3 lines of mappings): AACA,CAAO,MAAN,MAAM,CAAC,CAAE,CAAC,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC;AAC7B,AAAA,WAAC,GAAG,CAAC,CAAA,MAAA,KAAY,CAAC,EAAE,CAAC,MAAM,CAAA,CAAA,CAAhB,AAAC,MAAA,YAAe;AAC3B,AAAA,GAAG,OAAO,CAAC,GAAG,CAAA,AAAC,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,EAAE,KAAK,CAAC,CAAC
[PREPROC_CIVET /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/fixtures/loopGoodExp.svelte] Reindented compiled TS code for insertion (indent: ""):

	const fruits = ["apple", "mango"]
	let i = 0;for (const fruit of fruits) {const index = i++;
	  console.log(`Fruit ${index + 1}: ${fruit}`)
	}
// Comment

Original Svelte Content:
 <script lang="civet">
	fruits := ["apple", "mango"]
	for fruit, index of fruits
	  console.log `Fruit ${index + 1}: ${fruit}`
// Comment
</script>
<div>{fruits}</div> 
Compiled TS Code (from preprocessor):
 	const fruits = ["apple", "mango"]
	let i = 0;for (const fruit of fruits) {const index = i++;
	  console.log(`Fruit ${index + 1}: ${fruit}`)
	}
// Comment

Info from CivetBlockInfo:
  originalContentStartLine_1based: 2
  originalCivetLineCount: 6
  compiledTsLineCount: 7
Raw Civet-to-TS map lines (first 3): [
  [
    [ 0, 0, 0, 0 ],  [ 1, 0, 0, 7 ],
    [ 6, 0, 0, 1 ],  [ 6, 0, 0, 7 ],
    [ 1, 0, 0, 8 ],  [ 1, 0, 0, 10 ],
    [ 1, 0, 0, 11 ], [ 1, 0, 0, 12 ],
    [ 7, 0, 0, 19 ], [ 1, 0, 0, 20 ],
    [ 1, 0, 0, 21 ], [ 7, 0, 0, 28 ],
    [ 1, 0, 0, 29 ]
  ],
  [
    [ 0, 0, 1, 0 ],  [ 0, 0, 1, 0 ],
    [ 1 ],           [ 4 ],
    [ 1 ],           [ 4 ],
    [ 1, 0, 1, 1 ],  [ 3, 0, 1, 4 ],
    [ 1, 0, 1, 5 ],  [ 1, 0, 1, 5 ],
    [ 6, 0, 1, 5 ],  [ 5, 0, 1, 17 ],
    [ 1, 0, 1, 18 ], [ 2, 0, 1, 20 ],
    [ 1, 0, 1, 21 ], [ 6, 0, 1, 27 ],
    [ 1, 0, 1, 27 ], [ 1, 0, 1, 27 ],
    [ 1, 0, 1, 11 ], [ 0, 0, 1, 12 ],
    [ 6, 0, 1, 12 ], [ 5 ],
    [ 3 ],           [ 1 ],
    [ 2 ],           [ 1, 0, 1, 27 ]
  ],
  [
    [ 0, 0, 2, 0 ],  [ 0, 0, 2, 0 ],
    [ 3, 0, 2, 3 ],  [ 7, 0, 2, 10 ],
    [ 1, 0, 2, 11 ], [ 3, 0, 2, 14 ],
    [ 1, 0, 2, 14 ], [ 0, 0, 2, 15 ],
    [ 1, 0, 2, 16 ], [ 6, 0, 2, 22 ],
    [ 2, 0, 2, 24 ], [ 5, 0, 2, 29 ],
    [ 1, 0, 2, 30 ], [ 1, 0, 2, 31 ],
    [ 1, 0, 2, 32 ], [ 1, 0, 2, 33 ],
    [ 1, 0, 2, 34 ], [ 2, 0, 2, 36 ],
    [ 2, 0, 2, 38 ], [ 5, 0, 2, 43 ],
    [ 1, 0, 2, 44 ], [ 1, 0, 2, 45 ],
    [ 1 ]
  ]
]
Normalized V3 map from Preprocessor (first 3 mapping lines):
AACA,CAAO,MAAN,MAAM,CAAC,CAAE,CAAC,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC;AAC7B,AAAA,WAAC,GAAG,CAAC,CAAA,MAAA,KAAY,CAAC,EAAE,CAAC,MAAM,CAAA,CAAA,CAAhB,AAAC,MAAA,YAAe;AAC3B,AAAA,GAAG,OAAO,CAAC,GAAG,CAAA,AAAC,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,EAAE,KAAK,CAAC,CAAC
Decoded V3 mapping segments:
  TS Line 1: [0,0,1,0] [1,0,1,7] [7,0,1,1] [13,0,1,7] [14,0,1,8] [15,0,1,10] [16,0,1,11] [17,0,1,12] [24,0,1,19] [25,0,1,20] [26,0,1,21] [33,0,1,28] [34,0,1,29]
  TS Line 2: [0,0,2,0] [0,0,2,0] [11,0,2,1] [14,0,2,4] [15,0,2,5] [16,0,2,5] [22,0,2,5] [27,0,2,17] [28,0,2,18] [30,0,2,20] [31,0,2,21] [37,0,2,27] [38,0,2,27] [39,0,2,27] [40,0,2,11] [40,0,2,12] [46,0,2,12] [58,0,2,27]
  TS Line 3: [0,0,3,0] [0,0,3,0] [3,0,3,3] [10,0,3,10] [11,0,3,11] [14,0,3,14] [15,0,3,14] [15,0,3,15] [16,0,3,16] [22,0,3,22] [24,0,3,24] [29,0,3,29] [30,0,3,30] [31,0,3,31] [32,0,3,32] [33,0,3,33] [34,0,3,34] [36,0,3,36] [38,0,3,38] [43,0,3,43] [44,0,3,44] [45,0,3,45]
  TS Line 4: [1,0,3,45] [2,0,3,45]
  TS Line 5: [0,0,4,0] [0,0,4,0] [10,0,4,10]
  TS Line 6: [0,0,5,0]
  Asserted token 'fruits_def' ('fruits'): TS(1:7) -> Original(2:1) - OK
    2) should correctly map tokens for Loop with trailing comment


  0 passing (197ms)
  2 failing

  1) 2.1 - Preprocessor loop mapping differences #current
       should correctly map tokens for Loop without trailing comment:

      AssertionError [ERR_ASSERTION]: Original column mismatch for token 'fruits_loop'
      + expected - actual

      -21
      +20
      
      at /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/2.1 - current - loopsPreprocessor.test.ts:148:16
      at Generator.next (<anonymous>)
      at fulfilled (test/civet/2.1 - current - loopsPreprocessor.test.ts:38:58)

  2) 2.1 - Preprocessor loop mapping differences #current
       should correctly map tokens for Loop with trailing comment:

      AssertionError [ERR_ASSERTION]: Original column mismatch for token 'fruits_loop'
      + expected - actual

      -21
      +20
      
      at /home/user/Documents/repos/ltools-backup/packages/svelte2tsx/test/civet/2.1 - current - loopsPreprocessor.test.ts:148:16
      at Generator.next (<anonymous>)
      at fulfilled (test/civet/2.1 - current - loopsPreprocessor.test.ts:38:58)
      at processTicksAndRejections (node:internal/process/task_queues:95:5)



/home/user/Documents/repos/ltools-backup/packages/svelte2tsx:
 ERR_PNPM_RECURSIVE_RUN_FIRST_FAIL  svelte2tsx@0.7.35 test-current: `mocha test/test.ts --grep "#current"`
Exit status 2
