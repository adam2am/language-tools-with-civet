# Refactoring Plan: Civet Sourcemap Correction for Leading Blank Lines

## 1. Executive Summary & Goals
This plan outlines the steps to diagnose and fix a bug where sourcemap generation for Svelte components with `<script lang="civet">` blocks is incorrect if the script content starts with a blank line. The incorrect mapping hinders debugging by misdirecting developers from generated TSX code back to the original Svelte/Civet source.

**Key Goals:**
1.  Achieve accurate sourcemap generation for Civet script blocks, irrespective of leading blank lines in the script content.
2.  Identify and rectify the precise root cause of the off-by-one line mapping error, suspected to be within the `civetPreprocessor.ts` or `civetMapToV3.ts` logic.
3.  Ensure the provided test case (`9 - LazerFocusBlankLine.test.ts` for `LazerFocus2-issue4.svelte`) passes with the corrected mapping (i.e., `problematicFoo` has a zero offset).

## 2. Current Situation Analysis
Based on the `User Task` (Bug Analysis Report):
*   **Observed Behavior:** When a `<script lang="civet">` block in a Svelte file contains a blank line between the tag and the first line of Civet code, sourcemaps are generated incorrectly. The test `9 - LazerFocusBlankLine.test.ts` demonstrates this with `LazerFocus2-issue4.svelte`, where `problematicFoo` is expected to have a non-zero offset due to the bug.
*   **Expected Behavior:** Sourcemaps should accurately map from the generated TSX back to the original Civet code in the Svelte file, regardless of such leading blank lines. For `LazerFocus2-issue4.svelte`, `problematicFoo` should map with a zero offset.
*   **Most Likely Cause (from report):** Hypothesis 1 suggests `snippetHadLeadingNewline` in `normalizeCivetMap` (`civetMapToV3.ts`) is incorrectly evaluated to `true` for the problematic case. This would occur if `dedentedSnippet` (which becomes `civetMap.source`) unexpectedly starts with a newline, possibly due to an edge case in `snippet.replace` or `stripCommonIndent` in `civetPreprocessor.ts`. This would cause a one-line upward shift in the final mapping.
*   **Key Files Involved:**
    *   `packages/svelte2tsx/src/svelte2tsx/utils/civetPreprocessor.ts`
    *   `packages/svelte2tsx/src/svelte2tsx/utils/civetMapToV3.ts`
    *   `packages/svelte2tsx/src/svelte2tsx/utils/civetUtils.ts` (`stripCommonIndent`, `getActualContentStartLine`)
    *   `packages/svelte2tsx/src/svelte2tsx/index.ts` (Civet block info propagation)

## 3. Proposed Solution / Refactoring Strategy

### 3.1. High-Level Approach
The strategy is to first meticulously verify the assumptions made in the bug report's trace, focusing on Hypothesis 1. This involves targeted debugging and logging to observe intermediate states of variables like `snippet`, `snippetTrimmed`, `dedentedSnippet`, `civetMap.source`, and `snippetHadLeadingNewline`. Once the exact point of divergence from expected behavior is found, a precise fix will be implemented in the relevant module.

### 3.2. Key Modules to Inspect/Modify
The investigation and potential modifications will primarily target:
*   `packages/svelte2tsx/src/svelte2tsx/utils/civetPreprocessor.ts`: For `snippet.replace(/^[ \t]*[\r\n]+/, '')` and `stripCommonIndent()` behavior.
*   `packages/svelte2tsx/src/svelte2tsx/utils/civetMapToV3.ts`: For `normalizeCivetMap`'s handling of `civetMap.source`, `snippetHadLeadingNewline`, and the application of `originalCivetSnippetLineOffset_0based`.
*   `packages/svelte2tsx/src/svelte2tsx/utils/civetUtils.ts`: If `stripCommonIndent` or `getActualContentStartLine` are found to behave unexpectedly.

### 3.3. Detailed Action Plan / Phases

#### Phase 1: Diagnostics & Root Cause Confirmation
   - **Objective(s):** Precisely identify why the sourcemap is off-by-one for the problematic case. Confirm or refute Hypothesis 1 by inspecting intermediate variable values.
   - **Priority:** High

   - **Task 1.1:** Implement Detailed Logging
      - **Rationale/Goal:** To capture the actual values of key variables during the processing of `LazerFocus2-issue4.svelte` and `LazerFocus2-issue4-allgood.svelte` for comparison.
      - **Locations for Logging:**
         1.  In `civetPreprocessor.ts` (before `compileCivet` call):
             *   `filename`
             *   `snippet` (raw content of script tag)
             *   `snippetTrimmed` (after `snippet.replace`)
             *   `dedentedSnippet` (after `stripCommonIndent`)
             *   `originalContentStartLine_1based`
         2.  In `civetMapToV3.ts` (inside `normalizeCivetMap`):
             *   `svelteFilePath`
             *   `civetMap.source` (this should be `dedentedSnippet`)
             *   `snippetHadLeadingNewline` (boolean value)
             *   `originalCivetSnippetLineOffset_0based`
             *   For `problematicFoo` mapping: `originalLine_0based_in_snippet`, `effective_originalLine_0based_in_snippet`, `finalOriginalLine_1based_in_svelte`.
      - **Estimated Effort:** Medium
      - **Deliverable/Criteria for Completion:** Logs generated for both test files, allowing comparison of critical intermediate values. Clear evidence supporting or refuting Hypothesis 1.

   - **Task 1.2:** Utilize Breakpoints for Dynamic Inspection
      - **Rationale/Goal:** To step through the code execution for `LazerFocus2-issue4.svelte` and inspect variable states not easily captured by logs, or to explore execution paths dynamically.
      - **Breakpoint Locations:**
         1.  In `civetPreprocessor.ts`: After `dedentedSnippet` is computed. Inspect its value.
         2.  In `civetMapToV3.ts`: At the start of `normalizeCivetMap`. Inspect `civetMap.source`, `originalCivetSnippetLineOffset_0based`. Step through logic for `problematicFoo`.
      - **Estimated Effort:** Medium (often done in conjunction with logging)
      - **Deliverable/Criteria for Completion:** Confirmed execution flow and variable states, leading to a precise understanding of the deviation point.

   - **Task 1.3:** Confirm Whitespace Content
      - **Rationale/Goal:** The exact nature of the "blank line" in `LazerFocus2-issue4.svelte` can influence `stripCommonIndent` or `replace`.
      - **Action:** Manually inspect `packages/svelte2tsx/test/civet/fixtures/lazerfocusOffset/LazerFocus2-issue4.svelte` using an editor that shows invisible characters or a hex editor to determine the exact characters on the line after `<script lang="civet">`.
      - **Estimated Effort:** Small
      - **Deliverable/Criteria for Completion:** Confirmed sequence of whitespace characters (e.g., `\t\n`, `\n`, ` \n`).

#### Phase 2: Implementation of Fix
   - **Objective(s):** Correct the logic that leads to the incorrect sourcemap offset.
   - **Priority:** High (once Phase 1 identifies the root cause)

   - **Task 2.1:** Implement Code Correction
      - **Rationale/Goal:** To alter the faulty logic identified in Phase 1.
      - **Potential Actions (depending on Phase 1 findings):**
         *   If `stripCommonIndent` incorrectly produces a leading newline for the problematic input: Modify `stripCommonIndent` in `civetUtils.ts` to handle this edge case correctly.
         *   If `snippet.replace` in `civetPreprocessor.ts` is not aggressive enough or behaves unexpectedly for the specific whitespace: Adjust its regex or logic.
         *   If `snippetHadLeadingNewline` in `normalizeCivetMap` is problematic due to `civetMap.source` being unexpectedly altered: Investigate why `civetMap.source` differs from the expected `dedentedSnippet` or adjust how `snippetHadLeadingNewline` is used or derived.
         *   If `originalCivetSnippetLineOffset_0based` calculation or application is subtly wrong for this case: Correct it.
      - **Estimated Effort:** Small to Medium (depending on the complexity of the fix)
      - **Deliverable/Criteria for Completion:** Modified code that addresses the identified root cause. Unit tests for any modified utility functions (like `stripCommonIndent`) if applicable.

#### Phase 3: Verification & Test Adaptation
   - **Objective(s):** Ensure the fix works correctly, doesn't introduce regressions, and the test suite reflects the corrected behavior.
   - **Priority:** High

   - **Task 3.1:** Update and Run Test Case
      - **Rationale/Goal:** To confirm the bug is fixed and the primary test case now passes with the expected zero offset.
      - **Action:**
         1. Modify `packages/svelte2tsx/test/civet/9 - LazerFocusBlankLine.test.ts`. For the `LazerFocus2-issue4.svelte` case, change the assertion from `assert.notStrictEqual(offset, 0, ...)` to `assert.strictEqual(offset, 0, ...)`. The `expectOffset: 0` in the fixture data correctly reflects the desired state post-fix.
         2. Run the test suite, specifically `9 - LazerFocusBlankLine.test.ts`.
      - **Estimated Effort:** Small
      - **Deliverable/Criteria for Completion:** `9 - LazerFocusBlankLine.test.ts` passes for both `LazerFocus2-issue4-allgood.svelte` and `LazerFocus2-issue4.svelte`, with `problematicFoo` showing a `0` offset in both.

   - **Task 3.2 (Optional but Recommended):** Add Additional Test Cases
      - **Rationale/Goal:** To ensure robustness against various leading whitespace patterns.
      - **Action:** Create new Svelte fixture files with different leading blank line configurations (e.g., two blank lines, lines with only spaces then newline, CR+LF line endings) and add corresponding test cases.
      - **Estimated Effort:** Small to Medium
      - **Deliverable/Criteria for Completion:** Expanded test suite covering more whitespace scenarios, all passing.

## 4. Key Considerations & Risk Mitigation

### 4.1. Technical Risks & Challenges
   - **Subtlety of Whitespace Processing:** The interaction between `String.prototype.replace` with regex, `stripCommonIndent`, and `getActualContentStartLine` can be complex, especially with diverse whitespace patterns (tabs, spaces, newlines, CR+LF). A fix for one pattern might inadvertently affect others.
      - **Mitigation:** Thorough logging during Phase 1 for different inputs. Comprehensive testing in Phase 3 with a variety of whitespace patterns, including those that currently work.
   - **Unexpected Civet Compiler Behavior:** While less likely, the Civet compiler's `rawMap.source` could differ from `dedentedSnippet` in an unexpected way.
      - **Mitigation:** Logging `civetMap.source` in Phase 1.

### 4.2. Dependencies
   - **Internal:** Tasks within phases are largely sequential. Phase 1 must complete before Phase 2, and Phase 2 before Phase 3.
   - **External:** No external team dependencies are anticipated.

### 4.3. Non-Functional Requirements (NFRs) Addressed
   - **Correctness:** The primary NFR. The fix will ensure accurate sourcemap generation.
   - **Maintainability:** The diagnostic process and subsequent fix should aim for clear, understandable code in the affected modules. If utility functions are modified, they should remain robust and well-documented.
   - **Debuggability (for Svelte/Civet users):** Greatly improved as developers will be able to reliably set breakpoints and interpret stack traces.

## 5. Success Metrics / Validation Criteria
1.  The test `packages/svelte2tsx/test/civet/9 - LazerFocusBlankLine.test.ts` passes successfully for both `LazerFocus2-issue4-allgood.svelte` and the (now fixed) `LazerFocus2-issue4.svelte`. Specifically, the calculated `offset` for `problematicFoo` must be `0` for both files, and the test assertions must reflect this.
2.  Manual inspection of the sourcemap (e.g., using browser developer tools or an IDE debugger) for `LazerFocus2-issue4.svelte` shows that breakpoints on `problematicFoo` in the generated TSX correctly map to its definition in the original Svelte file's Civet script.
3.  No regressions are introduced in other Civet-related or general sourcemapping tests.

## 6. Assumptions Made
1.  The detailed bug analysis in the `User Task` is largely accurate, especially regarding the code paths and Hypothesis 1 being the most probable area of concern.
2.  The `@danielx/civet` compiler produces consistent and correct raw sourcemaps (specifically `rawMap.lines` and `rawMap.source`) when given identical `dedentedSnippet` inputs.
3.  The `chainMaps` function in `civetMapChainer.ts` is fundamentally correct in its general sourcemap chaining logic post its recent refactoring, and the issue lies in the data preparation or normalization stages for individual Civet blocks.
4.  The file structure provided is accurate and relevant.

## 7. Open Questions / Areas for Further Investigation
1.  **Crucial Confirmation:** What are the *exact* logged values for `snippet`, `snippetTrimmed`, `dedentedSnippet` (input to `compileCivet`), and `civetMap.source` (in `normalizeCivetMap`) when processing `LazerFocus2-issue4.svelte`? This is key to confirming or refuting Hypothesis 1.
2.  **`snippetHadLeadingNewline` Value:** What is the actual boolean value of `snippetHadLeadingNewline` in `normalizeCivetMap` for `LazerFocus2-issue4.svelte`?
3.  If Hypothesis 1 is disproven (i.e., `dedentedSnippet` is clean and `snippetHadLeadingNewline` is correctly `false`), what other subtle factor is causing the off-by-one error? The investigation would then need to widen slightly, re-evaluating assumptions about `originalCivetSnippetLineOffset_0based` or other aspects of `normalizeCivetMap`.
4.  **Team Discussion Point:** Before starting Phase 2 (Implementation), the findings from Phase 1 (Diagnostics) should be reviewed to ensure consensus on the root cause and the proposed fix.