# Core Findings: Civet Source Map Generation & Preprocessor Integration

This document summarizes the investigation into enabling source maps for Civet code when used with `svelte-preprocess-with-civet`.

# Civet Preprocessor Findings & Current+Further Steps

## Current Status & Next Milestone (As of Test Run Confirming V3 Maps)

**`svelte-preprocess-with-civet` is now confirmed to generate V3 source maps.**

*   **Key Improvement & Validation:** The transformer in `svelte-preprocess-with-civet-Repo/src/transformers/civet.ts` was previously updated to:
    *   Consistently pass `{ sync: true, js: false, sourceMap: true }` (among other options) to `@danielx/civet` when the user requests source maps.
    *   This results in `@danielx/civet` returning an object `{ code: "...", sourceMap: <CivetSourceMapInstance> }`.
    *   Crucially, the transformer calls `civetResult.sourceMap.json(filename, outputFilename)` on the Civet `SourceMap` instance, converting Civet's internal map into a **standard V3 source map object**.
    *   The preprocessor returns `{ code: civetResult.code, map: <V3MapObject> }`.
*   **Successful Test Run:** The `testPreProcTest.mjs` script (configured with `{ civet: { sourceMap: true } }`) was executed and its output confirmed:
    *   No JSON parsing errors.
    *   `result.code` contained clean TypeScript.
    *   `result.map` was a **V3 source map object**, validated by checking for standard keys like `version` (which was 3), `sources`, and `mappings`.

**Next Milestone: Downstream Consumption of V3 Source Map**

*   **Main Idea, Aim:** Verify that the V3 source map generated by `svelte-preprocess-with-civet` can be correctly consumed and chained by downstream tools, primarily `svelte2tsx` and the Svelte Language Server / TypeScript Language Service.
*   **Testing Focus:**
    *   Ensure `SvelteDocument.ts` (or equivalent in the language server) correctly ingests the `map` object from the preprocessor.
    *   Confirm that `DocumentSnapshot.ts` can chain this (Civet -> TS) map with the map generated by `svelte2tsx` (TS -> TSX).
    *   Test end-to-end IDE features: hover, go-to-definition, and diagnostics, ensuring they map accurately back to the original Civet code in `.svelte` files.




---
# Historical Log of Key Discoveries, Milestones (can be written only up,)

## Read-only milestones bellow after being written (freshest=up, historically=down):

[2] 
### Fixed: `svelte-preprocess-with-civet` Adopts Civet's Object-based Source Maps to a V3 out

*   **Context:** Following the `SyntaxError` with `JSON.parse()` and insights into `@danielx/civet`'s ability to return a map object, `svelte-preprocess-with-civet` was updated.
*   **Thoughts:** The map object from `@danielx/civet` (keys observed: `data, source, renderMappings, json, updateSourceMap`) is **not standard V3 SourceMap format**.
*   **Actions:** Investigate this format. Determine if it can be converted to V3 or used directly by `svelte2tsx` / TypeScript Language Service. These tools typically expect V3.
*   **Modification:** The transformer in `svelte-preprocess-with-civet/src/transformers/civet.ts` was modified:
    *   It began passing `{ sync: true, js: false }` to `@danielx/civet` generally.
    *   When source maps were requested by the user (e.g., `sveltePreprocess({ civet: { sourceMap: true } })`), it specifically instructed `@danielx/civet` to return a map object by including `sourceMap: true` in its compilation options.
    *   `@danielx/civet` would then return an object like `{ code: "...", sourceMap: { ...mapObject... } }`.
    *   The transformer was updated to use this structure, returning `{ code: civetResult.code, map: civetResult.sourceMap }` to Svelte.
    *   The `Options.Civet` type definition (in `svelte-preprocess-with-civet-Repo/src/types/options.ts`) was also augmented with `inlineMap?: boolean;` to reflect compiler option capabilities.
*   **Outcome & Validation:**
    *   The `SyntaxError: Unexpected token o in JSON` was resolved.
    *   Test runs (e.g., with `testPreProcTest.mjs` configured for source maps) confirmed that `result.code` was clean TypeScript, and `result.map` now contained the raw map object directly from Civet.

### Discovery: Civet's Native Source Map Object is Non-Standard

*   **Observation:** Upon successfully retrieving the source map object from `@danielx/civet` via `svelte-preprocess-with-civet`, further inspection revealed its structure.
*   **Format:** The map object (with keys like `data, source, renderMappings, json, updateSourceMap`) was identified as **not conforming to the standard V3 SourceMap format** commonly expected by downstream tools like `svelte2tsx` and the TypeScript Language Service.
*   **Implication:** This new challenge meant this custom Civet map object would need conversion to V3 or a method for downstream tools to consume it directly before the V3 map generation (described in the current status section) was achieved.




[1]
### Initial Behaviors of `svelte-preprocess-with-civet`

*   **State+question:** Using `sourceMap: true` with `svelte-preprocess-with-civet` caused a `SyntaxError: Unexpected token o in JSON at position 1`.
*   **Reason:** The preprocessor was incorrectly trying to `JSON.parse()` the output from `@danielx/civet` when source maps were enabled, regardless of the actual output structure.

### `@danielx/civet` Source Map Generation Insights

Investigation revealed how `Civet.compile()` behaves with different options:

1.  **Preferred Method for Synchronous Code + Map Object:**
    *   **Options:** `{ sourceMap: true, sync: true, js: false }`
    *   **Returns:** An object: `{ code: "compiled TS", sourceMap: { ...mapData... } }`.
    *   **Significance:** This became the target for `svelte-preprocess-with-civet`.

2.  **Synchronous Code + Inline String Map:**
    *   **Options:** `{ inlineMap: true, sync: true, js: false }`
    *   **Returns:** A string: `"compiled TS code... //# sourceMappingURL=..."`.
    *   **Significance:** A viable, but less direct, way to get maps. Would require parsing the inline comment.

3.  **Asynchronous Code + Inline String Map:**
    *   **Options:** `await Civet.compile(civetCode, { inlineMap: true, js: false })`
    *   **Returns:** A string: `"compiled TS code... //# sourceMappingURL=..."`.

4.  **Incorrect Synchronous Attempts (Resulting in Empty Object `{}` from Civet):**
    *   `{ sourceMap: true, js: false }` (without `sync: true`)
    *   `{ inlineMap: true, js: false }` (without `sync: true`)

### Intermediate Test of `svelte-preprocess-with-civet` (Before Final Fix)

*   **Scenario:** Configured with `{ civet: { inlineMap: true, sync: true } }`.
*   **Result:**
    *   JSON error resolved (as Civet returned a string).
    *   `result.code` contained TS + the inline map comment.
    *   `result.map` was undefined (preprocessor didn't parse the inline map).
*   **Learning:** Confirmed the preprocessor needed logic to handle Civet's output string if inline maps were used, but also highlighted the need for a more direct object-based map if possible.





















